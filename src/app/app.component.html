<!-- app.component.html -->
<div class="character-creator-container p-4 md:p-8 bg-gray-100 min-h-screen">
  <div class="max-w-4xl mx-auto">
    
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold text-red-700">Criador de Personagens D&D 5e</h1>
        <p class="text-lg text-gray-600">Construa seu herói passo a passo</p>
    </div>

    <!-- Passo 0: Nome do Personagem -->
    <p-card *ngIf="currentStep === 0" header="Passo 0: Comece sua Jornada" subheader="Dê um nome ao seu herói e comece uma nova aventura ou importe um personagem existente.">
      <div class="field mb-4">
        <label for="character-name" class="block text-lg font-medium text-gray-700 mb-2">Nome do Personagem</label>
        <input id="character-name" type="text" pInputText [(ngModel)]="character.name" class="w-full">
      </div>
      <ng-template pTemplate="footer">
        <div class="flex justify-between items-center gap-4">
            <button pButton pRipple label="Importar JSON" icon="pi pi-upload" class="p-button-secondary" (click)="fileInput.click()"></button>
            <input #fileInput type="file" (change)="handleFileUpload($event)" class="hidden" accept=".json">

            <button pButton pRipple label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="nextStep()" [disabled]="!character.name || character.name.trim() === ''"></button>
        </div>
      </ng-template>
    </p-card>

  <!-- Outros Passos -->
    <div *ngIf="currentStep > 0 && currentStep < 6">
        <p-card>
            <!-- Título dinâmico do Card -->
            <ng-template pTemplate="title">
              <span *ngIf="currentStep === 1">Passo 1: Escolha sua Raça</span>
              <span *ngIf="currentStep === 2">Passo 2: Escolha sua Classe</span>
              <span *ngIf="currentStep === 3">Passo 3: Determine os Atributos</span>
              <span *ngIf="currentStep === 4">Passo 4: Escolha seu Antecedente</span>
              <span *ngIf="currentStep === 5">Passo 5: Equipamento Inicial</span>
            </ng-template>

            <!-- Conteúdo de cada passo -->
            <div *ngIf="currentStep === 1">
              <div class="field mb-4">
                <label class="block mb-2">Raça</label>
                <p-dropdown [options]="races" [(ngModel)]="selectedRace" optionLabel="name" placeholder="-- Escolha uma Raça --" [showClear]="true" (onChange)="onRaceSelected($event)" styleClass="w-full"></p-dropdown>
              </div>
              <div *ngIf="selectedRace?.subraces?.length" class="field mb-4">
                <label class="block mb-2">Sub-raça</label>
                <p-dropdown [options]="selectedRace.subraces" [(ngModel)]="selectedSubrace" optionLabel="name" placeholder="-- Escolha uma Sub-raça --" [showClear]="true" (onChange)="onSubraceSelected($event)" styleClass="w-full"></p-dropdown>
              </div>
            </div>

            <div *ngIf="currentStep === 2">
              <div class="field mb-4">
                <label class="block mb-2">Classe</label>
                <p-dropdown [options]="classes" [(ngModel)]="selectedClass" optionLabel="name" placeholder="-- Escolha uma Classe --" [showClear]="true" (onChange)="onClassSelected($event)" styleClass="w-full"></p-dropdown>
              </div>
            </div>

            <div *ngIf="currentStep === 4">
                <div class="field mb-4">
                    <label class="block mb-2">Antecedente</label>
                    <p-dropdown [options]="backgrounds" [(ngModel)]="selectedBackground" optionLabel="name" placeholder="-- Escolha um Antecedente --" [showClear]="true" (onChange)="onBackgroundSelected($event)" styleClass="w-full"></p-dropdown>
                </div>
            </div>

            <!-- Passo 3: Valores de Habilidade -->
            <div *ngIf="currentStep === 3">
              <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 3: Determine os Valores de Habilidade</h2>
              <div class="mb-4">
                <label class="mr-2">Método:</label>
                <select [(ngModel)]="abilityScoreMethod" (ngModelChange)="initializeAbilityScores()" class="p-2 border rounded-lg shadow-sm">
                  <option value="standard">Valores Padrão</option>
                  <option value="roll">Rolar Dados (4d6kh3)</option>
                  <option value="pointbuy">Compra por Pontos</option>
                </select>
              </div>

            <!-- Info para Roll e Standard -->
            <div *ngIf="abilityScoreMethod === 'roll'" class="mb-4 flex items-center gap-4">
              <button (click)="onRollScores()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">Rolar Dados</button>
              <button *ngIf="abilityScorePool.length > 0" (click)="resetScoreAssignments()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Limpar Seleções</button>
            </div>
            <div *ngIf="abilityScoreMethod === 'standard'" class="mb-4 flex items-center gap-4">
              <p>Use os valores: {{ standardArray.join(', ') }}.</p>
              <button (click)="resetScoreAssignments()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Limpar Seleções</button>
            </div>
            
            <!-- Info para Point Buy -->
            <div *ngIf="abilityScoreMethod === 'pointbuy'" class="mb-4">
                <p class="font-semibold">Pontos Restantes: <span [class.text-red-500]="pointBuyPoints < 0">{{ pointBuyPoints }}</span></p>
                <p class="text-xs text-gray-600">Custos: 8 (0), 9 (1), 10 (2), 11 (3), 12 (4), 13 (5), 14 (7), 15 (9).</p>
            </div>

            <!-- Inputs de Habilidade -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <!-- UI para Point Buy -->
                <ng-container *ngIf="abilityScoreMethod === 'pointbuy'">
                    <div *ngFor="let ability of abilityKeys" class="mb-2">
                        <label class="font-semibold capitalize text-red-700">{{ ability.charAt(0).toUpperCase() + ability.slice(1) }}:</label>
                        <input type="number"
                              [(ngModel)]="assignedScores[ability]"
                              (ngModelChange)="recalculatePointBuyPoints()"
                              min="8" max="15"
                              class="w-full p-2 border rounded-lg shadow-sm mt-1">
                    </div>
                </ng-container>

                <!-- UI para Standard/Roll -->
                <ng-container *ngIf="abilityScoreMethod === 'standard' || abilityScoreMethod === 'roll'">
                    <div *ngFor="let ability of abilityKeys" class="mb-2">
                        <label class="font-semibold capitalize text-red-700">{{ ability.charAt(0).toUpperCase() + ability.slice(1) }}:</label>
                        <select [(ngModel)]="assignedScores[ability]" class="w-full p-2 border rounded-lg shadow-sm mt-1 bg-white">
                            <option [ngValue]="0" disabled>Escolha...</option>
                            <option *ngFor="let score of getAvailableScoresFor(ability)" [ngValue]="score">
                                {{ score }}
                            </option>
                        </select>
                    </div>
                </ng-container>
            </div>

            <!-- Validação e Navegação -->
            <div *ngIf="abilityScoreMethod === 'pointbuy' && pointBuyPoints !== 0" class="mt-2 text-red-500 font-semibold">
                Você deve usar exatamente 27 pontos. Pontos restantes: {{ pointBuyPoints }}.
            </div>
            <div *ngIf="(abilityScoreMethod === 'standard' || abilityScoreMethod === 'roll') && isNextStepInStep3Disabled && abilityScorePool.length > 0" class="mt-2 text-red-500 font-semibold">
                Por favor, atribua um valor para cada habilidade.
            </div>

            <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
            <button (click)="nextStep()" [disabled]="isNextStepInStep3Disabled"
                    class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
              Próximo
            </button>
          </div>

  <!-- Passo 4: Antecedente -->
  <div *ngIf="currentStep === 4">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 4: Escolha seu Antecedente</h2>
    <div class="mb-4">
      <label for="background-select" class="block text-lg font-medium text-gray-700">Antecedente</label>
      <select id="background-select" (change)="onBackgroundSelected($event)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md bg-white">
        <option value="">-- Escolha um Antecedente --</option>
        <option *ngFor="let bg of backgrounds" [value]="bg.name">
          {{ bg.name }}
        </option>
      </select>
    </div>

    <!-- Container para exibir detalhes do antecedente selecionado -->
    <div *ngIf="selectedBackground" class="mt-4 p-4 border rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold text-red-800">{{ selectedBackground.name }}</h3>
      <p class="mt-2 text-sm text-gray-700">{{ selectedBackground.description }}</p>
       <div class="mt-3">
        <p><strong class="font-semibold">Proficiência em Perícias:</strong> {{ selectedBackground.skillProficiencies.join(', ') }}</p>
        <p *ngIf="selectedBackground.toolProficiencies && selectedBackground.toolProficiencies.length > 0">
          <strong class="font-semibold">Proficiência com Ferramentas:</strong> {{ selectedBackground.toolProficiencies.join(', ') }}
        </p>
         <p *ngIf="selectedBackground.languages && selectedBackground.languages.length > 0">
          <strong class="font-semibold">Idiomas:</strong> {{ selectedBackground.languages.join(', ') }}
        </p>
      </div>
    </div>

    <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
    <button (click)="nextStep()" [disabled]="!selectedBackground"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
      Próximo
    </button>
  </div>

            <!-- Passo 5: Equipamento -->
            <div *ngIf="currentStep === 5">
                <h4 class="font-bold">Equipamento Sugerido:</h4>
                <ul class="list-disc list-inside mt-2">
                    <li *ngFor="let item of characterService.getStartingEquipment(selectedClass?.name, selectedBackground?.name)">
                        {{ item }}
                    </li>
                </ul>
            </div>
            <!-- Footer com Navegação -->
            <ng-template pTemplate="footer">
              <div class="flex justify-between">
                <button pButton pRipple label="Anterior" icon="pi pi-arrow-left" (click)="prevStep()" class="p-button-secondary"></button>
                <button pButton pRipple label="Próximo" icon="pi pi-arrow-right" iconPos="right" (click)="nextStep()" [disabled]="(currentStep === 1 && (!selectedRace || (selectedRace.subraces?.length && !selectedSubrace))) || (currentStep === 2 && !selectedClass) || (currentStep === 4 && !selectedBackground)"></button>
              </div>
            </ng-template>
        </p-card>
    </div>

  <!-- Passo 6: Resumo do Personagem -->
    <p-card *ngIf="currentStep === 6 && character.name" header="Ficha de Personagem">
        <!-- O conteúdo do resumo aqui -->
        <div class="bg-white rounded-lg space-y-4">
            <!-- (Código do resumo omitido para brevidade, permanece o mesmo) -->
        </div>
        <ng-template pTemplate="footer">
            <div class="flex justify-between">
              <button pButton pRipple label="Voltar ao Início" icon="pi pi-replay" (click)="resetToInitialState()" class="p-button-secondary"></button>
              <button pButton pRipple label="Exportar JSON" icon="pi pi-download" (click)="downloadJson()" class="p-button-success"></button>
            </div>
        </ng-template>
    </p-card>

  </div>
</div>