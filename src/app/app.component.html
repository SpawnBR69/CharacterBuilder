<div class="container mx-auto p-4 font-sans">
  <h1 class="text-3xl font-bold mb-6 text-center text-red-700">Criador de Personagens D&D 5e</h1>

  <!-- Passo 0: Nome do Personagem -->
  <div *ngIf="currentStep === 0">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 0: Comece sua Jornada</h2>
    <div class="mb-4">
      <label for="character-name" class="block text-lg font-medium text-gray-700">Qual o nome do seu personagem?</label>
      <input type="text" id="character-name" [(ngModel)]="character.name" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md">
    </div>
    <div class="flex items-center gap-4 mt-8">
        <button (click)="nextStep()" [disabled]="!character.name || character.name.trim() === ''"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
          Criar Novo Personagem
        </button>
        <span class="text-gray-500">ou</span>
        <label for="import-json" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow cursor-pointer">
          Importar JSON
        </label>
        <input type="file" id="import-json" (change)="handleFileUpload($event)" class="hidden" accept=".json">
    </div>
  </div>

  <!-- Passo 1: Raça -->
  <div *ngIf="currentStep === 1">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 1: Escolha sua Raça</h2>
    
    <!-- Caixa de Seleção para Raças -->
    <div class="mb-4">
      <label for="race-select" class="block text-lg font-medium text-gray-700">Raça</label>
      <select id="race-select" (change)="onRaceSelected($event)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md bg-white">
        <option value="">-- Escolha uma Raça --</option>
        <option *ngFor="let race of races" [value]="race.name">
          {{ race.name }} ({{ race.sourceBook }})
        </option>
      </select>
    </div>

    <!-- Container para exibir detalhes da raça selecionada -->
    <div *ngIf="selectedRace" class="mt-4 p-4 border rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold text-red-800">{{ selectedRace.name }}</h3>
      <p class="mt-2 text-sm text-gray-700">{{ selectedRace.description }}</p>
      
      <div class="mt-3">
        <p><strong class="font-semibold">Aumento de Valor de Habilidade:</strong> 
          <span *ngFor="let increase of selectedRace.abilityScoreIncrease | keyvalue">
            {{ increase.key | titlecase }} +{{ increase.value }}. 
          </span>
        </p>
        <p><strong class="font-semibold">Deslocamento:</strong> {{ selectedRace.speed }} metros.</p>
        <p><strong class="font-semibold">Idiomas:</strong> {{ selectedRace.languages?.join(', ') }}.</p>
        <div *ngIf="selectedRace.traits && selectedRace.traits.length > 0">
          <strong class="font-semibold">Traços Raciais:</strong>
          <ul class="list-disc list-inside ml-4">
            <li *ngFor="let trait of selectedRace.traits">{{ trait }}</li>
          </ul>
        </div>
      </div>
      
      <!-- Caixa de Seleção para Sub-raças (se aplicável) -->
      <div *ngIf="selectedRace.subraces && selectedRace.subraces.length > 0" class="mt-4">
        <label for="subrace-select" class="block text-lg font-medium text-gray-700">Sub-raça</label>
        <select id="subrace-select" (change)="onSubraceSelected($event)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md bg-white">
          <option value="">-- Escolha uma Sub-raça --</option>
          <option *ngFor="let subrace of selectedRace.subraces" [value]="subrace.name">
            {{ subrace.name }}
          </option>
        </select>
      </div>

      <!-- Detalhes da Sub-raça Selecionada -->
      <div *ngIf="selectedSubrace" class="mt-3 p-3 border-t border-gray-200">
        <h4 class="text-lg font-bold text-red-700">{{ selectedSubrace.name }}</h4>
        <p class="mt-1 text-sm text-gray-600">{{ selectedSubrace.description }}</p>
        <p class="mt-1"><strong class="font-semibold">Aumento Adicional:</strong> 
          <span *ngFor="let increase of selectedSubrace.abilityScoreIncrease | keyvalue">
            {{ increase.key | titlecase }} +{{ increase.value }}.
          </span>
        </p>
        <div *ngIf="selectedSubrace.traits && selectedSubrace.traits.length > 0">
          <strong class="font-semibold">Traços de Sub-raça:</strong>
          <ul class="list-disc list-inside ml-4">
            <li *ngFor="let trait of selectedSubrace.traits">{{ trait }}</li>
          </ul>
        </div>
      </div>
    </div>

    <button (click)="nextStep()" [disabled]="!selectedRace || (selectedRace.subraces && selectedRace.subraces.length > 0 && !selectedSubrace)"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
      Próximo
    </button>
  </div>

  <!-- Passo 2: Classe -->
  <div *ngIf="currentStep === 2">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 2: Escolha sua Classe</h2>
    <div class="mb-4">
      <label for="class-select" class="block text-lg font-medium text-gray-700">Classe</label>
      <select id="class-select" (change)="onClassSelected($event)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md bg-white">
        <option value="">-- Escolha uma Classe --</option>
        <option *ngFor="let cls of classes" [value]="cls.name">
          {{ cls.name }}
        </option>
      </select>
    </div>

    <!-- Container para exibir detalhes da classe selecionada -->
    <div *ngIf="selectedClass" class="mt-4 p-4 border rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold text-red-800">{{ selectedClass.name }}</h3>
      <p class="mt-2 text-sm text-gray-700">{{ selectedClass.description }}</p>
      <div class="mt-3">
        <p><strong class="font-semibold">Dado de Vida:</strong> d{{ selectedClass.hitDie }}</p>
        <p><strong class="font-semibold">Habilidade Primária:</strong> {{ selectedClass.primaryAbility.join(', ') }}</p>
        <p><strong class="font-semibold">Proficiência em Testes de Resistência:</strong> {{ selectedClass.savingThrowProficiencies.join(', ') }}</p>
        <p><strong class="font-semibold">Proficiências com Armas e Armaduras:</strong> {{ selectedClass.armorAndWeaponProficiencies.join(', ') }}</p>
      </div>
    </div>

    <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
    <button (click)="nextStep()" [disabled]="!selectedClass"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
      Próximo
    </button>
  </div>

  <!-- Passo 3: Valores de Habilidade -->
  <div *ngIf="currentStep === 3">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 3: Determine os Valores de Habilidade</h2>
    <div class="mb-4">
      <label class="mr-2">Método:</label>
      <select [(ngModel)]="abilityScoreMethod" (ngModelChange)="initializeAbilityScores()" class="p-2 border rounded-lg shadow-sm">
        <option value="standard">Valores Padrão</option>
        <option value="roll">Rolar Dados (4d6kh3)</option>
        <option value="pointbuy">Compra por Pontos</option>
      </select>
    </div>

    <!-- Info para Roll e Standard -->
    <div *ngIf="abilityScoreMethod === 'roll'" class="mb-4 flex items-center gap-4">
      <button (click)="onRollScores()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow">Rolar Dados</button>
      <button *ngIf="abilityScorePool.length > 0" (click)="resetScoreAssignments()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Limpar Seleções</button>
    </div>
    <div *ngIf="abilityScoreMethod === 'standard'" class="mb-4 flex items-center gap-4">
      <p>Use os valores: {{ standardArray.join(', ') }}.</p>
      <button (click)="resetScoreAssignments()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Limpar Seleções</button>
    </div>
    
    <!-- Info para Point Buy -->
    <div *ngIf="abilityScoreMethod === 'pointbuy'" class="mb-4">
        <p class="font-semibold">Pontos Restantes: <span [class.text-red-500]="pointBuyPoints < 0">{{ pointBuyPoints }}</span></p>
        <p class="text-xs text-gray-600">Custos: 8 (0), 9 (1), 10 (2), 11 (3), 12 (4), 13 (5), 14 (7), 15 (9).</p>
    </div>

    <!-- Inputs de Habilidade -->
    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
        <!-- UI para Point Buy -->
        <ng-container *ngIf="abilityScoreMethod === 'pointbuy'">
            <div *ngFor="let ability of abilityKeys" class="mb-2">
                <label class="font-semibold capitalize text-red-700">{{ ability.charAt(0).toUpperCase() + ability.slice(1) }}:</label>
                <input type="number"
                       [(ngModel)]="assignedScores[ability]"
                       (ngModelChange)="recalculatePointBuyPoints()"
                       min="8" max="15"
                       class="w-full p-2 border rounded-lg shadow-sm mt-1">
            </div>
        </ng-container>

        <!-- UI para Standard/Roll -->
        <ng-container *ngIf="abilityScoreMethod === 'standard' || abilityScoreMethod === 'roll'">
            <div *ngFor="let ability of abilityKeys" class="mb-2">
                <label class="font-semibold capitalize text-red-700">{{ ability.charAt(0).toUpperCase() + ability.slice(1) }}:</label>
                <select [(ngModel)]="assignedScores[ability]" class="w-full p-2 border rounded-lg shadow-sm mt-1 bg-white">
                    <option [ngValue]="0" disabled>Escolha...</option>
                    <option *ngFor="let score of getAvailableScoresFor(ability)" [ngValue]="score">
                        {{ score }}
                    </option>
                </select>
            </div>
        </ng-container>
    </div>

    <!-- Validação e Navegação -->
    <div *ngIf="abilityScoreMethod === 'pointbuy' && pointBuyPoints !== 0" class="mt-2 text-red-500 font-semibold">
        Você deve usar exatamente 27 pontos. Pontos restantes: {{ pointBuyPoints }}.
    </div>
    <div *ngIf="(abilityScoreMethod === 'standard' || abilityScoreMethod === 'roll') && isNextStepInStep3Disabled && abilityScorePool.length > 0" class="mt-2 text-red-500 font-semibold">
        Por favor, atribua um valor para cada habilidade.
    </div>

    <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
    <button (click)="nextStep()" [disabled]="isNextStepInStep3Disabled"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
      Próximo
    </button>
  </div>

  <!-- Passo 4: Antecedente -->
  <div *ngIf="currentStep === 4">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 4: Escolha seu Antecedente</h2>
    <div class="mb-4">
      <label for="background-select" class="block text-lg font-medium text-gray-700">Antecedente</label>
      <select id="background-select" (change)="onBackgroundSelected($event)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm rounded-md bg-white">
        <option value="">-- Escolha um Antecedente --</option>
        <option *ngFor="let bg of backgrounds" [value]="bg.name">
          {{ bg.name }}
        </option>
      </select>
    </div>

    <!-- Container para exibir detalhes do antecedente selecionado -->
    <div *ngIf="selectedBackground" class="mt-4 p-4 border rounded-lg bg-gray-50">
      <h3 class="text-xl font-bold text-red-800">{{ selectedBackground.name }}</h3>
      <p class="mt-2 text-sm text-gray-700">{{ selectedBackground.description }}</p>
       <div class="mt-3">
        <p><strong class="font-semibold">Proficiência em Perícias:</strong> {{ selectedBackground.skillProficiencies.join(', ') }}</p>
        <p *ngIf="selectedBackground.toolProficiencies && selectedBackground.toolProficiencies.length > 0">
          <strong class="font-semibold">Proficiência com Ferramentas:</strong> {{ selectedBackground.toolProficiencies.join(', ') }}
        </p>
         <p *ngIf="selectedBackground.languages && selectedBackground.languages.length > 0">
          <strong class="font-semibold">Idiomas:</strong> {{ selectedBackground.languages.join(', ') }}
        </p>
      </div>
    </div>

    <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
    <button (click)="nextStep()" [disabled]="!selectedBackground"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow disabled:opacity-50">
      Próximo
    </button>
  </div>

   <!-- Passo 5: Equipamento (Simplificado) -->
  <div *ngIf="currentStep === 5">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Passo 5: Equipamento</h2>
    <p class="mb-2">Seu equipamento inicial é determinado pela sua classe e antecedente.</p>
    <p class="mb-4 text-sm text-gray-600">(Em uma aplicação completa, aqui haveria opções de escolha baseadas nas regras do Livro do Jogador).</p>
    <div>
        <h3 class="text-lg font-semibold text-red-700">Equipamento Sugerido:</h3>
        <ul class="list-disc list-inside mt-2">
            <!-- Acessar characterService que agora é público -->
            <li *ngFor="let item of characterService.getStartingEquipment(character.class?.name, character.background?.name)">
                {{ item }}
            </li>
        </ul>
    </div>
    <button (click)="prevStep()" class="mt-6 mr-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Anterior</button>
    <button (click)="nextStep()"
            class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow">
      Ver Resumo
    </button>
  </div>

  <!-- Passo 6: Resumo do Personagem -->
  <div *ngIf="currentStep === 6">
    <h2 class="text-2xl font-semibold mb-4 text-red-600">Ficha de Personagem</h2>
    <div class="bg-white p-6 rounded-lg shadow-lg space-y-4">
      
      <!-- Informações Básicas -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-b pb-4">
        <div><strong class="block text-red-700">Nome:</strong> {{ character.name }}</div>
        <div><strong class="block text-red-700">Classe & Nível:</strong> {{ character.class?.name }} {{ character.level }}</div>
        <div><strong class="block text-red-700">Antecedente:</strong> {{ character.background?.name }}</div>
        <div><strong class="block text-red-700">Raça:</strong> {{ character.race?.name }} {{ character.subrace ? '(' + character.subrace.name + ')' : '' }}</div>
        <div><strong class="block text-red-700">Alinhamento:</strong> {{ character.alignment || 'Não definido' }}</div>
      </div>

      <!-- Atributos e Modificadores -->
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
        <div *ngFor="let ability of abilityKeys" class="p-2 border rounded-lg">
          <div class="text-sm font-bold text-red-700 uppercase">{{ ability.slice(0,3) }}</div>
          <div class="text-2xl font-bold">{{ getAbilityModifierString(character.abilityScores![ability]) }}</div>
          <div class="text-sm text-gray-600">{{ character.abilityScores![ability] }}</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Coluna Esquerda: Testes de Resistência e Perícias -->
        <div class="md:col-span-1 space-y-4">
          <div>
            <h4 class="font-bold text-red-700 border-b mb-2">Testes de Resistência</h4>
            <ul>
              <li *ngFor="let key of abilityKeys" class="flex items-center">
                <span class="inline-block w-4 h-4 mr-2 border rounded-full flex items-center justify-center text-xs">
                  <span *ngIf="character.savingThrows![key].proficient" class="w-2 h-2 bg-gray-800 rounded-full"></span>
                </span>
                <span class="font-semibold mr-1">{{ (character.savingThrows![key].value >= 0 ? '+' : '') + character.savingThrows![key].value }}</span>
                <span class="text-gray-600 capitalize">{{ key }}</span>
              </li>
            </ul>
          </div>
          <div>
            <h4 class="font-bold text-red-700 border-b mb-2">Perícias</h4>
            <ul>
                <li *ngFor="let skill of character.skills | keyvalue" class="flex items-center text-sm">
                    <span class="inline-block w-4 h-4 mr-2 border rounded-full flex items-center justify-center text-xs">
                        <span *ngIf="skill.value.proficient" class="w-2 h-2 bg-gray-800 rounded-full"></span>
                    </span>
                    <span class="font-semibold mr-1">{{ (getAbilityModifier(character.abilityScores![skill.value.ability]) + (skill.value.proficient ? character.proficiencyBonus! : 0) >= 0 ? '+' : '') + (getAbilityModifier(character.abilityScores![skill.value.ability]) + (skill.value.proficient ? character.proficiencyBonus! : 0)) }}</span>
                    <span class="text-gray-600">{{ skill.key }} <span class="text-gray-400">({{skill.value.ability.slice(0,3)}})</span></span>
                </li>
            </ul>
          </div>
        </div>
        
        <!-- Coluna Central: Combate e Traços -->
        <div class="md:col-span-2 space-y-4">
            <div class="grid grid-cols-3 gap-2 text-center">
              <div class="p-2 border rounded-lg"><strong class="block text-red-700">Classe de Armadura</strong><span class="text-xl">{{ character.armorClass }}</span></div>
              <div class="p-2 border rounded-lg"><strong class="block text-red-700">Iniciativa</strong><span class="text-xl">{{ (character.initiative! >= 0 ? '+' : '') + character.initiative }}</span></div>
              <div class="p-2 border rounded-lg"><strong class="block text-red-700">Deslocamento</strong><span class="text-xl">{{ character.race?.speed }} m</span></div>
            </div>
            <div class="p-2 border rounded-lg">
                <strong class="block text-red-700 text-center">Pontos de Vida</strong>
                <div class="text-center text-xl">{{character.hitPoints?.current}} / {{character.hitPoints?.max}}</div>
            </div>
             <div>
                <h4 class="font-bold text-red-700 border-b mb-2">Traços e Características</h4>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                    <li *ngFor="let trait of character.traits">{{ trait }}</li>
                </ul>
            </div>
        </div>
      </div>
      
       <!-- Equipamento -->
       <div>
            <h4 class="font-bold text-red-700 border-b mb-2">Equipamento</h4>
            <p class="text-sm text-gray-600">{{ character.equipment?.join(', ') }}</p>
       </div>
    </div>
    
    <!-- Botões de Ação Final -->
    <div class="mt-8 flex justify-between">
      <button (click)="resetToInitialState()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow">Voltar ao Início</button>
      <button (click)="downloadJson()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow">Exportar para JSON</button>
    </div>
  </div>
</div>